#â—˜[include mmu/base/*.cfg]
#[include mmu/addons/mmu_erec_cutter.cfg]
#[include mmu/optional/client_macros.cfg]
#[include mmu/optional/mmu_ercf_compat.cfg]

####################################################################
############################## MCU #################################
####################################################################
[mcu]
#serial: /dev/serial/by-id/usb-Klipper_stm32f429xx_2F004C000951303439373431-if00
canbus_uuid:1f3a5bc4b712
[mcu EBB36]
serial: /dev/serial/by-id/usb-Klipper_stm32g0b1xx_560046001450425539393020-if00
#[mcu ERCF]
#canbus_uuid:e2e6ea2a9fde

####################################################################
########################### FUNCTIONS ##############################
####################################################################
[include fluidd.cfg]
[include K-ShakeTune/*.cfg]
[include macro.cfg]

[shaketune]
 result_folder: ~/printer_data/config/ShakeTune_results
#    The folder where the results will be stored. It will be created if it doesn't exist.
number_of_results_to_keep: 10
#    The number of results to keep in the result_folder. The oldest results will
#    be automatically deleted after each runs.
keep_raw_csv: False
#    If True, the raw CSV files will be kept in the result_folder alongside the
#    PNG graphs. If False, they will be deleted and only the graphs will be kept.
show_macros_in_webui: True
#    Mainsail and Fluidd doesn't create buttons for "system" macros that are not in the
#    printer.cfg file. If you want to see the macros in the webui, set this to True.
# timeout: 300
#    The maximum time in seconds to let Shake&Tune process the CSV files and generate the graphs.


#[include adxl.cfg]

[virtual_sdcard]
path: /home/hevort/printer_data/gcodes
on_error_gcode: CANCEL_PRINT

[display_status]

[exclude_object]

[gcode_arcs]  #Required for OrcaSlicer when using Z-hop. Orca does spiral wipes and needs G2/G3 to do so.
#resolution: 1.0

####################################################################
############################ PRINTER ###############################
####################################################################
[printer]
kinematics: corexy
max_velocity: 500
max_accel: 20000
max_z_velocity: 40
max_z_accel: 300
square_corner_velocity: 5

#[safe_z_home]
#home_xy_position: 195,150
#z_hop: 10
#z_hop_speed: 10

[pause_resume]
recover_velocity: 100

[input_shaper]
shaper_freq_x: 129.2  # per accelerometer
shaper_type_x: ei
shaper_freq_y: 130.8  # per accelerometer
shaper_type_y: 3hump_ei

####################################################################
############################ X AXIS ################################
####################################################################
#_____________________ XY Motor Mapping ____________________________
# 
#                           BACK  
#             Y_____________________________X
#              |                            | 
#              |                            | 
#              |                            | 
#          L   |                            |   R
#          E   |                            |   I
#          F   |                            |   G
#          T   |                            |   H
#              |                            |   T
#              |                            | 
#              |  0,0                       | 
#            X1|____________________________|Y1
#                         
#                         FRONT
#  ______________________________________________________________
# | DRIVE | STEP pin | DIR pin  | EN pin   | CS PIN   | END_STOP |
# |-------|----------|----------|----------|----------|----------|
# | X1    | PF11     | PG3      | PG5      | PC6      | CANBUS   |
# | X     | PG4      | PC1      | PA0      | PC7      |          |
# |_______|__________|__________|__________|__________|__________|

#____________________ MOTOR X __________________________
[stepper_x]           
step_pin: PG4
dir_pin: PC1
enable_pin: !PA0
microsteps: 16
rotation_distance: 40
endstop_pin: ^EBB36: PB6
position_endstop: 0
position_min: 0
position_max: 390
homing_speed: 150
full_steps_per_rotation: 400
homing_retract_dist: 0
homing_positive_dir: false

[tmc5160 stepper_x]
cs_pin: PC7
sense_resistor: 0.022
spi_software_miso_pin: PA6
spi_software_mosi_pin: PA7
spi_software_sclk_pin: PA5
interpolate: false
run_current: 1.2

#____________________ MOTOR X1 _________________________
[stepper_x1]           
step_pin: PF11
dir_pin: PG3
enable_pin: !PG5 
microsteps: 16
rotation_distance: 40
full_steps_per_rotation: 400


[tmc5160 stepper_x1]
cs_pin: PC6
sense_resistor: 0.022
spi_software_miso_pin: PA6
spi_software_mosi_pin: PA7
spi_software_sclk_pin: PA5
interpolate: false
run_current: 1.2

####################################################################
############################ Y AXIS ################################
####################################################################
# | DRIVE | STEP pin | DIR pin  | EN pin   | CS PIN   | END_STOP |
# |-------|----------|----------|----------|----------|----------|
# | Y1    | PF13     | PF12     | PF14     | PC4      |          |
# | Y     | PG0      | PG1      | PF15     | PD11     | PG11     |

#____________________ MOTOR Y __________________________
[stepper_y]           
step_pin: PG0
dir_pin: PG1
enable_pin: !PF15
microsteps: 16
rotation_distance: 40
endstop_pin: ^PG11
position_endstop: 0
position_min: 0
position_max: 380
homing_speed: 150
full_steps_per_rotation: 400
homing_retract_dist: 0
homing_positive_dir: false

[tmc5160 stepper_y]
cs_pin: PD11
sense_resistor: 0.022
spi_software_miso_pin: PA6
spi_software_mosi_pin: PA7
spi_software_sclk_pin: PA5
interpolate: false
run_current: 1.2

#____________________ MOTOR Y1 _________________________
[stepper_y1]           
step_pin: PF13
dir_pin: PF12
enable_pin: !PF14 
microsteps: 16
rotation_distance: 40
full_steps_per_rotation: 400


[tmc5160 stepper_y1]
cs_pin: PC4
sense_resistor: 0.022
spi_software_miso_pin: PA6
spi_software_mosi_pin: PA7
spi_software_sclk_pin: PA5
interpolate: false
run_current: 1.2

####################################################################
############################ Z AXIS ################################
####################################################################
# | DRIVE | STEP pin | DIR pin  | EN pin   | CS PIN   | END_STOP |
# |-------|----------|----------|----------|----------|----------|
# | Z     | PF9      | PF10     | PG2      | PF2      | PG12     |
# | Z1    | PC13     | PF0      | PF1      | PE4      | PD13     |
# | Z2    | PE2      | PE3      | PD4      | PE1      | PD14     |

#____________________ MOTOR Z  _______________________
[stepper_z]         
step_pin: PF9
dir_pin: PF10
enable_pin: !PG2

microsteps: 32
rotation_distance: 4 				
full_steps_per_rotation: 200
endstop_pin: probe:z_virtual_endstop
position_max: 350
position_min: -2 #Using negative value will allow bed to go past 0 to reach Z Probe in case of unlevelled bed.
homing_speed: 20
homing_retract_dist: 0 # beacon needs this to be set to 0

[tmc5160 stepper_z]
cs_pin: PF2
spi_software_sclk_pin: PA5
spi_software_mosi_pin: PA7
spi_software_miso_pin: PA6
interpolate: false
run_current: 1.6
#____________________ MOTOR Z1 _______________________
[stepper_z1]          
step_pin: PC13
dir_pin: PF0
enable_pin: !PF1
microsteps: 32
rotation_distance: 4 				
full_steps_per_rotation: 200

[tmc5160 stepper_z1]
cs_pin: PE4
spi_software_sclk_pin: PA5
spi_software_mosi_pin: PA7
spi_software_miso_pin: PA6
interpolate: false
run_current: 1.6
#____________________ MOTOR Z2 _______________________
[stepper_z2]
step_pin: PE2
dir_pin: PE3
enable_pin: !PD4
microsteps: 32
rotation_distance: 4 				
full_steps_per_rotation: 200

[tmc5160 stepper_z2]
cs_pin: PE1
spi_software_sclk_pin: PA5
spi_software_mosi_pin: PA7
spi_software_miso_pin: PA6
interpolate: false
run_current: 1.6

#____________________ ACTIVE - Beacon3D Eddy Current _______________
[beacon]
serial: /dev/serial/by-id/usb-Beacon_Beacon_RevD_71FC66C74E4B333448202020FF0A2035-if00
x_offset: 0         # update with offset from nozzle on your machine
y_offset: 20.5        # update with offset from nozzle on your machine
mesh_main_direction: x
mesh_runs: 2
home_xy_position: 195,195
home_z_hop: 10
home_z_hop_speed: 10
home_xy_move_speed: 300
speed: 10         # Z probing dive speed.
lift_speed: 15     # Z probing lift speed.

#____________________ ACTIVE - SELF LEVELLING (Z_Tilt) _____________
[z_tilt]
z_positions: 
    -22.940, -10.300
    195.768, 402.910
    414.476, -10.300

points:
	20,0
	20,320
    370,320
    #195.77,320
	370,0       

speed: 300
horizontal_move_z: 15
retries: 3  #   Number of times to retry if the probed points aren't within a givin tolerance
retry_tolerance: 0.05

[axis_twist_compensation]
 speed: 80
#   The speed (in mm/s) of non-probing moves during the calibration.
#   The default is 50.
horizontal_move_z: 5
#   The height (in mm) that the head should be commanded to move to
#   just prior to starting a probe operation. The default is 5.
calibrate_start_x: 20
#   Defines the minimum X coordinate of the calibration
#   This should be the X coordinate that positions the nozzle at the starting               !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
#   calibration position. This parameter must be provided.
calibrate_end_x: 370
#   Defines the maximum X coordinate of the calibration
#   This should be the X coordinate that positions the nozzle at the ending
#   calibration position. This parameter must be provided.
calibrate_y: 180
#   Defines the Y coordinate of the calibration
#   This should be the Y coordinate that positions the nozzle during the
#   calibration process. This parameter must be provided and is recommended to
#   be near the center of the bed

#____________________ ACTIVE - BED MESH ____________________________
[bed_mesh]
algorithm: bicubic
bicubic_tension: 0.2
speed: 500
horizontal_move_z: 2
mesh_min: 20, 21 #Probe position
mesh_max: 370,340 
probe_count: 20,20
fade_start: 1
fade_end: 5

##################################################################
########################## EXTRUDER ##############################
##################################################################


#____________________ ACTIVE - Extruder On Drive 6 ####_________________
[extruder]
step_pin: EBB36: PD0
dir_pin: !EBB36: PD1
enable_pin: !EBB36: PD2

microsteps: 16
full_steps_per_rotation: 200
rotation_distance: 4.4548195847022
nozzle_diameter: 0.400
filament_diameter: 1.750
max_extrude_cross_section:5

#____________________ PT1000 CanBus _____________
heater_pin: EBB36: PB13
sensor_type: PT1000    
sensor_pin: EBB36: PA3
pullup_resistor: 2200

control: pid
pid_Kp=21.110 
pid_Ki=2.070 
pid_Kd=53.829

min_temp: 10
max_temp: 350
min_extrude_temp: 10

pressure_advance = 0.011
max_extrude_only_distance: 150.0

[tmc2209 extruder]
uart_pin: EBB36: PA15
interpolate: false
run_current: 0.800
sense_resistor: 0.110

[firmware_retraction]
retract_length: 0.5
#   The length of filament (in mm) to retract when G10 is activated,
#   and to unretract when G11 is activated (but see
#   unretract_extra_length below). The default is 0 mm.
retract_speed: 50
#   The speed of retraction, in mm/s. The default is 20 mm/s.
unretract_extra_length: 0
#   The length (in mm) of *additional* filament to add when
#   unretracting.
unretract_speed: 50
#   The speed of unretraction, in mm/s. The default is 10 mm/s.

####################################################################
############################ BED ###################################
####################################################################
[heater_bed]
heater_pin: PA1
sensor_type: Generic 3950
sensor_pin: PF3
min_temp: 0
max_temp: 110

control: pid
pid_Kp=67.905 
pid_Ki=2.558 
pid_Kd=450.720

####################################################################
###################### FANS & THERMISTORS ##########################
####################################################################
[thermistor NTC10K] #http://docs.ldomotors.com/en/guides/klipper-thermistor
temperature1: 0.0
resistance1: 32116.0
temperature2: 40.0
resistance2: 5309.0
temperature3: 80.0
resistance3: 1228.0

#  ____________________________________________________________________
#| HEATER |  HEAT pin |  TEMP pin | Accesories                         |
#| BED    | PA1       | (TB) PF3  | BED + thermistor                   |
#| HE0    | PA2       | (TO) PF4  | Watter pump PW + watter thermistr  |
#| HE1    | PA3       | (T1) PF5  | Electronic thermistor              |
#| HE2    | PB10      | (T2) PF6  | Chamber thermistor                 |
#| HE3    | PB11      | (T3) PF7  |                                    |   
# | ______|___________|___________|____________________________________|
#  _________________________________________________ 
# | FAN   |    PIN    | Accessories                 |
# |-------|-----------|-----------------------------|
# | FAN0  | PA8       | Water pump PWM              |
# | FAN1  | PE5       | Cooling Radiator            |
# | FAN2  | PD12      | Octopus driver              |
# | FAN3  | PD13      | White LED                   |
# | FAN4  | PD14      | UV - LED top + back plate   |
# | FAN5  | PD15      | UV - LED water tank         |
# | FAN6  | ALWAYS_ON | RPI - fan                   |
# | FAN7  | ALWAYS_ON | Electronic - fan            |
# | ______|___________|_____________________________|

[multi_pin led_uv]
pins: PD14, PD15

[output_pin LED-UV]
pin: multi_pin:led_uv

[output_pin LED-Chamber]
pin: PD13

#[output_pin FAN-EBB36]
#pin: EBB36: PA0

[fan]  #CPAP settings
pin: EBB36: PD3
kick_start_time: 0.05
off_below: 0.08
cycle_time: 0.0002

[heater_fan Driver]
pin: PD12
heater: extruder
heater_temp: 20

[neopixel Neopixel]
pin:PB6
chain_count:13
color_order: GRB

[led_effect blue]
autostart:true
frame_rate:24
leds:
    neopixel:Neopixel
layers:
    static  0 1 top (0,0,1,0)

[heater_fan WaterPump] # Power for Water Pump 24V
pin: PA2
heater: extruder
heater_temp: 40.0
shutdown_speed: 0.0
kick_start_time: 0.1
# RPM monitoring:
tachometer_pin: ^PG12
tachometer_ppr: 3

[heater_fan Radiator]
pin: PE5
heater: extruder
heater_temp: 30

[fan_generic Exhaust]
pin: PA8

[temperature_sensor Chamber]
sensor_type: ATC Semitec 104GT-2 
sensor_pin: PF6

[temperature_sensor Watter]
sensor_type: NTC10K
sensor_pin: PF4

[temperature_sensor Electronic]
sensor_type: ATC Semitec 104GT-2 
sensor_pin: PF5

[temperature_sensor Octopus PRO]
sensor_type: temperature_mcu
sensor_mcu: mcu  

[temperature_sensor Raspberry Pi4]
sensor_type: temperature_host

[temperature_sensor CanBus]
sensor_type: temperature_mcu
sensor_mcu: EBB36

####################################################################
###################### END of manual config ########################
####################################################################

#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [beacon model default]
#*# model_coef = 1.3826820268565914,
#*# 	  1.712519481627127,
#*# 	  0.8016986477440543,
#*# 	  0.3423026289012224,
#*# 	  0.23521622783172064,
#*# 	  0.4053224610218828,
#*# 	  0.02273429288456903,
#*# 	  -0.2779825156007401,
#*# 	  0.1572973494896658,
#*# 	  0.22015119145832385
#*# model_domain = 3.093406241467905e-07,3.3228058039205e-07
#*# model_range = 0.200000,5.000000
#*# model_temp = 35.839635
#*# model_offset = 0.00000
#*#
#*# [bed_mesh default]
#*# version = 1
#*# points =
#*# 	0.124955, 0.096393, 0.081790, 0.081254, 0.080930, 0.075853, 0.069814, 0.062016, 0.057545, 0.063238, 0.073805, 0.084038, 0.094169, 0.098923, 0.091080, 0.084046, 0.077705, 0.077451, 0.082808, 0.095151
#*# 	0.099130, 0.072665, 0.062229, 0.065708, 0.064255, 0.061515, 0.056493, 0.051127, 0.048050, 0.054096, 0.066437, 0.076657, 0.087646, 0.092863, 0.088398, 0.076995, 0.073513, 0.073279, 0.085060, 0.098570
#*# 	0.083528, 0.058537, 0.051234, 0.052567, 0.052481, 0.049169, 0.045881, 0.039404, 0.037791, 0.043585, 0.058546, 0.070346, 0.080922, 0.084679, 0.079235, 0.072302, 0.068944, 0.071132, 0.081886, 0.096219
#*# 	0.063475, 0.043387, 0.038217, 0.039225, 0.036788, 0.035166, 0.032306, 0.029019, 0.028711, 0.036802, 0.051474, 0.063947, 0.074967, 0.078283, 0.075447, 0.064951, 0.061425, 0.063666, 0.076690, 0.088466
#*# 	0.045143, 0.027005, 0.020424, 0.023860, 0.022369, 0.017539, 0.018263, 0.014164, 0.014097, 0.022438, 0.038915, 0.049334, 0.062584, 0.069530, 0.065351, 0.055415, 0.051599, 0.055725, 0.066722, 0.081030
#*# 	0.029269, 0.009865, 0.004443, 0.009251, 0.006088, 0.002447, 0.000452, -0.002137, -0.002974, 0.007862, 0.020813, 0.033740, 0.045236, 0.053737, 0.049734, 0.040005, 0.036246, 0.037161, 0.047903, 0.059771
#*# 	0.018490, -0.004082, -0.008199, -0.003578, -0.004329, -0.008382, -0.009162, -0.015466, -0.016002, -0.005908, 0.007438, 0.018514, 0.036036, 0.041849, 0.038178, 0.029646, 0.022129, 0.024366, 0.034858, 0.047325
#*# 	0.008109, -0.011049, -0.012379, -0.007354, -0.007599, -0.008266, -0.011947, -0.018100, -0.020568, -0.009938, 0.001488, 0.015836, 0.030381, 0.036656, 0.033897, 0.028399, 0.018235, 0.016334, 0.025429, 0.039129
#*# 	0.006894, -0.009565, -0.010051, -0.003973, -0.006380, -0.006234, -0.008958, -0.014414, -0.017270, -0.006303, 0.009671, 0.023536, 0.037567, 0.041069, 0.037466, 0.031187, 0.020895, 0.020442, 0.030895, 0.043467
#*# 	0.004371, -0.013470, -0.013976, -0.007838, -0.006443, -0.006860, -0.005531, -0.009869, -0.014408, -0.004855, 0.010393, 0.023397, 0.036659, 0.041575, 0.036004, 0.026940, 0.019053, 0.016970, 0.024797, 0.037943
#*# 	0.000935, -0.015216, -0.016230, -0.009272, -0.008130, -0.008109, -0.011113, -0.015560, -0.017067, -0.006281, 0.004406, 0.017497, 0.030273, 0.035344, 0.030780, 0.023211, 0.015941, 0.013797, 0.022822, 0.035722
#*# 	0.016382, 0.000965, -0.000456, 0.001092, 0.001377, -0.000776, -0.001575, -0.005504, -0.006648, 0.000896, 0.013121, 0.023425, 0.036901, 0.044605, 0.039918, 0.030477, 0.019976, 0.020736, 0.030502, 0.043843
#*# 	0.035160, 0.016107, 0.012987, 0.010218, 0.008416, 0.008069, 0.006845, 0.001775, 0.002856, 0.011516, 0.022525, 0.033173, 0.046149, 0.052829, 0.047667, 0.038641, 0.030195, 0.028354, 0.037042, 0.051773
#*# 	0.048478, 0.030584, 0.027075, 0.030122, 0.027837, 0.024908, 0.025903, 0.020931, 0.018704, 0.028119, 0.040493, 0.049543, 0.061846, 0.068609, 0.061391, 0.049683, 0.042704, 0.044402, 0.053820, 0.068329
#*# 	0.057525, 0.040274, 0.040322, 0.046304, 0.047662, 0.041383, 0.036593, 0.029359, 0.031057, 0.041923, 0.053716, 0.064679, 0.077651, 0.085461, 0.078042, 0.067666, 0.060145, 0.062415, 0.072347, 0.087880
#*# 	0.062236, 0.044362, 0.041651, 0.049999, 0.045439, 0.040787, 0.038134, 0.034316, 0.035203, 0.045123, 0.056980, 0.070653, 0.085992, 0.092821, 0.086975, 0.076454, 0.072811, 0.074394, 0.084701, 0.102933
#*# 	0.063472, 0.042933, 0.041433, 0.044183, 0.041990, 0.039633, 0.038983, 0.033675, 0.033380, 0.042285, 0.054943, 0.070076, 0.086390, 0.094351, 0.088155, 0.079700, 0.073772, 0.077196, 0.088996, 0.106432
#*# 	0.069276, 0.049873, 0.045904, 0.051262, 0.050241, 0.048040, 0.044047, 0.038224, 0.037207, 0.049188, 0.062185, 0.075703, 0.093810, 0.101529, 0.097575, 0.090149, 0.086712, 0.090186, 0.099616, 0.116160
#*# 	0.083722, 0.063240, 0.058934, 0.062959, 0.061865, 0.057534, 0.056749, 0.050256, 0.048429, 0.057683, 0.074715, 0.088781, 0.103538, 0.112697, 0.110197, 0.101767, 0.096488, 0.098908, 0.109120, 0.122665
#*# 	0.103491, 0.082689, 0.077158, 0.078866, 0.075387, 0.071621, 0.068430, 0.064726, 0.064122, 0.072526, 0.085042, 0.098553, 0.112882, 0.121178, 0.119101, 0.113093, 0.110414, 0.109826, 0.115750, 0.128286
#*# x_count = 20
#*# y_count = 20
#*# mesh_x_pps = 2
#*# mesh_y_pps = 2
#*# algo = bicubic
#*# tension = 0.2
#*# min_x = 20.0
#*# max_x = 370.0
#*# min_y = 21.0
#*# max_y = 350.0
