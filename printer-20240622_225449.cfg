#â—˜[include mmu/base/*.cfg]
#[include mmu/addons/mmu_erec_cutter.cfg]
#[include mmu/optional/client_macros.cfg]
#[include mmu/optional/mmu_ercf_compat.cfg]

####################################################################
############################## MCU #################################
####################################################################
[mcu]
#serial: /dev/serial/by-id/usb-Klipper_stm32f429xx_2F004C000951303439373431-if00
canbus_uuid:1f3a5bc4b712
[mcu EBB36]
serial: /dev/serial/by-id/usb-Klipper_stm32g0b1xx_560046001450425539393020-if00
#[mcu ERCF]
#canbus_uuid:e2e6ea2a9fde

####################################################################
########################### FUNCTIONS ##############################
####################################################################
[include fluidd.cfg]
[include K-ShakeTune/*.cfg]
[include macro.cfg]

[shaketune]
 result_folder: ~/printer_data/config/ShakeTune_results
#    The folder where the results will be stored. It will be created if it doesn't exist.
number_of_results_to_keep: 10
#    The number of results to keep in the result_folder. The oldest results will
#    be automatically deleted after each runs.
keep_raw_csv: False
#    If True, the raw CSV files will be kept in the result_folder alongside the
#    PNG graphs. If False, they will be deleted and only the graphs will be kept.
show_macros_in_webui: True
#    Mainsail and Fluidd doesn't create buttons for "system" macros that are not in the
#    printer.cfg file. If you want to see the macros in the webui, set this to True.
# timeout: 300
#    The maximum time in seconds to let Shake&Tune process the CSV files and generate the graphs.


#[include adxl.cfg]

[virtual_sdcard]
path: /home/hevort/printer_data/gcodes
on_error_gcode: CANCEL_PRINT

[display_status]

[exclude_object]

[gcode_arcs]  #Required for OrcaSlicer when using Z-hop. Orca does spiral wipes and needs G2/G3 to do so.
#resolution: 1.0

####################################################################
############################ PRINTER ###############################
####################################################################
[printer]
kinematics: corexy
max_velocity: 500
max_accel: 20000
max_z_velocity: 40
max_z_accel: 300
square_corner_velocity: 5

#[safe_z_home]
#home_xy_position: 195,150
#z_hop: 10
#z_hop_speed: 10

[pause_resume]
recover_velocity: 100

[input_shaper]
shaper_freq_x: 129.2  # per accelerometer
shaper_type_x: ei
shaper_freq_y: 130.8  # per accelerometer
shaper_type_y: 3hump_ei

####################################################################
############################ X AXIS ################################
####################################################################
#_____________________ XY Motor Mapping ____________________________
# 
#                           BACK  
#             Y_____________________________X
#              |                            | 
#              |                            | 
#              |                            | 
#          L   |                            |   R
#          E   |                            |   I
#          F   |                            |   G
#          T   |                            |   H
#              |                            |   T
#              |                            | 
#              |  0,0                       | 
#            X1|____________________________|Y1
#                         
#                         FRONT
#  ______________________________________________________________
# | DRIVE | STEP pin | DIR pin  | EN pin   | CS PIN   | END_STOP |
# |-------|----------|----------|----------|----------|----------|
# | X1    | PF11     | PG3      | PG5      | PC6      | CANBUS   |
# | X     | PG4      | PC1      | PA0      | PC7      |          |
# |_______|__________|__________|__________|__________|__________|

#____________________ MOTOR X __________________________
[stepper_x]           
step_pin: PG4
dir_pin: PC1
enable_pin: !PA0
microsteps: 16
rotation_distance: 40
endstop_pin: ^EBB36: PB6
position_endstop: 0
position_min: 0
position_max: 390
homing_speed: 150
full_steps_per_rotation: 400
homing_retract_dist: 0
homing_positive_dir: false

[tmc5160 stepper_x]
cs_pin: PC7
sense_resistor: 0.022
spi_software_miso_pin: PA6
spi_software_mosi_pin: PA7
spi_software_sclk_pin: PA5
interpolate: false
run_current: 1.1

#____________________ MOTOR X1 _________________________
[stepper_x1]           
step_pin: PF11
dir_pin: PG3
enable_pin: !PG5 
microsteps: 16
rotation_distance: 40
full_steps_per_rotation: 400


[tmc5160 stepper_x1]
cs_pin: PC6
sense_resistor: 0.022
spi_software_miso_pin: PA6
spi_software_mosi_pin: PA7
spi_software_sclk_pin: PA5
interpolate: false
run_current: 1.1

####################################################################
############################ Y AXIS ################################
####################################################################
# | DRIVE | STEP pin | DIR pin  | EN pin   | CS PIN   | END_STOP |
# |-------|----------|----------|----------|----------|----------|
# | Y1    | PF13     | PF12     | PF14     | PC4      |          |
# | Y     | PG0      | PG1      | PF15     | PD11     | PG11     |

#____________________ MOTOR Y __________________________
[stepper_y]           
step_pin: PG0
dir_pin: PG1
enable_pin: !PF15
microsteps: 16
rotation_distance: 40
endstop_pin: ^PG11
position_endstop: 0
position_min: 0
position_max: 350
homing_speed: 150
full_steps_per_rotation: 400
homing_retract_dist: 0
homing_positive_dir: false

[tmc5160 stepper_y]
cs_pin: PD11
sense_resistor: 0.022
spi_software_miso_pin: PA6
spi_software_mosi_pin: PA7
spi_software_sclk_pin: PA5
interpolate: false
run_current: 1.1

#____________________ MOTOR Y1 _________________________
[stepper_y1]           
step_pin: PF13
dir_pin: PF12
enable_pin: !PF14 
microsteps: 16
rotation_distance: 40
full_steps_per_rotation: 400


[tmc5160 stepper_y1]
cs_pin: PC4
sense_resistor: 0.022
spi_software_miso_pin: PA6
spi_software_mosi_pin: PA7
spi_software_sclk_pin: PA5
interpolate: false
run_current: 1.1

####################################################################
############################ Z AXIS ################################
####################################################################
# | DRIVE | STEP pin | DIR pin  | EN pin   | CS PIN   | END_STOP |
# |-------|----------|----------|----------|----------|----------|
# | Z     | PF9      | PF10     | PG2      | PF2      | PG12     |
# | Z1    | PC13     | PF0      | PF1      | PE4      | PD13     |
# | Z2    | PE2      | PE3      | PD4      | PE1      | PD14     |

#____________________ MOTOR Z  _______________________
[stepper_z]         
step_pin: PF9
dir_pin: PF10
enable_pin: !PG2

microsteps: 32
rotation_distance: 4 				
full_steps_per_rotation: 200
endstop_pin: probe:z_virtual_endstop
position_max: 350
position_min: -2 #Using negative value will allow bed to go past 0 to reach Z Probe in case of unlevelled bed.
homing_speed: 20
homing_retract_dist: 0 # beacon needs this to be set to 0

[tmc5160 stepper_z]
cs_pin: PF2
spi_software_sclk_pin: PA5
spi_software_mosi_pin: PA7
spi_software_miso_pin: PA6
interpolate: false
run_current: 1.2
#____________________ MOTOR Z1 _______________________
[stepper_z1]          
step_pin: PC13
dir_pin: PF0
enable_pin: !PF1
microsteps: 32
rotation_distance: 4 				
full_steps_per_rotation: 200

[tmc5160 stepper_z1]
cs_pin: PE4
spi_software_sclk_pin: PA5
spi_software_mosi_pin: PA7
spi_software_miso_pin: PA6
interpolate: false
run_current: 1.2
#____________________ MOTOR Z2 _______________________
[stepper_z2]
step_pin: PE2
dir_pin: PE3
enable_pin: !PD4
microsteps: 32
rotation_distance: 4 				
full_steps_per_rotation: 200

[tmc5160 stepper_z2]
cs_pin: PE1
spi_software_sclk_pin: PA5
spi_software_mosi_pin: PA7
spi_software_miso_pin: PA6
interpolate: false
run_current: 1.2

#____________________ ACTIVE - Beacon3D Eddy Current _______________
[beacon]
serial: /dev/serial/by-id/usb-Beacon_Beacon_RevD_71FC66C74E4B333448202020FF0A2035-if00
x_offset: 0         # update with offset from nozzle on your machine
y_offset: 51        # update with offset from nozzle on your machine
mesh_main_direction: x
mesh_runs: 2
home_xy_position: 195,195
home_z_hop: 10
home_z_hop_speed: 10
home_xy_move_speed: 300
speed: 10         # Z probing dive speed.
lift_speed: 30     # Z probing lift speed.

#____________________ ACTIVE - SELF LEVELLING (Z_Tilt) _____________
[z_tilt]
z_positions: 
    -22.940, -10.300
    195.768, 402.910
    414.476, -10.300

points:
	20,5
	#20,300
    #370,300
    194,300
	370,5       

speed: 300
horizontal_move_z: 15
retries: 3  #   Number of times to retry if the probed points aren't within a givin tolerance
retry_tolerance: 0.07

[axis_twist_compensation]
 speed: 80
#   The speed (in mm/s) of non-probing moves during the calibration.
#   The default is 50.
horizontal_move_z: 5
#   The height (in mm) that the head should be commanded to move to
#   just prior to starting a probe operation. The default is 5.
calibrate_start_x: 40
#   Defines the minimum X coordinate of the calibration
#   This should be the X coordinate that positions the nozzle at the starting               !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
#   calibration position. This parameter must be provided.
calibrate_end_x: 350
#   Defines the maximum X coordinate of the calibration
#   This should be the X coordinate that positions the nozzle at the ending
#   calibration position. This parameter must be provided.
calibrate_y: 180
#   Defines the Y coordinate of the calibration
#   This should be the Y coordinate that positions the nozzle during the
#   calibration process. This parameter must be provided and is recommended to
#   be near the center of the bed

#____________________ ACTIVE - BED MESH ____________________________
[bed_mesh]
algorithm: bicubic
bicubic_tension: 0.2
speed: 500
horizontal_move_z: 2
mesh_min: 10, 51 #Probe position
mesh_max: 380,350 
probe_count: 20,20
fade_start: 1
fade_end: 5

##################################################################
########################## EXTRUDER ##############################
##################################################################


#____________________ ACTIVE - Extruder On Drive 6 ####_________________
[extruder]
step_pin: EBB36: PD0
dir_pin: !EBB36: PD1
enable_pin: !EBB36: PD2

microsteps: 16
full_steps_per_rotation: 200
rotation_distance: 4.4548195847022
nozzle_diameter: 0.400
filament_diameter: 1.750
max_extrude_cross_section:5

#____________________ PT1000 CanBus _____________
heater_pin: EBB36: PB13
sensor_type: PT1000    
sensor_pin: EBB36: PA3
pullup_resistor: 2200

control: pid
pid_Kp=21.110 
pid_Ki=2.070 
pid_Kd=53.829

min_temp: 10
max_temp: 350
min_extrude_temp: 10

pressure_advance = 0.011
max_extrude_only_distance: 150.0

[tmc2209 extruder]
uart_pin: EBB36: PA15
interpolate: false
run_current: 0.800
sense_resistor: 0.110

[firmware_retraction]
retract_length: 0.2
#   The length of filament (in mm) to retract when G10 is activated,
#   and to unretract when G11 is activated (but see
#   unretract_extra_length below). The default is 0 mm.
retract_speed: 60
#   The speed of retraction, in mm/s. The default is 20 mm/s.
unretract_extra_length: 0
#   The length (in mm) of *additional* filament to add when
#   unretracting.
unretract_speed: 60
#   The speed of unretraction, in mm/s. The default is 10 mm/s.

####################################################################
############################ BED ###################################
####################################################################
[heater_bed]
heater_pin: PA1
sensor_type: Generic 3950
sensor_pin: PF3
min_temp: 0
max_temp: 110

control: pid
pid_Kp=67.905 
pid_Ki=2.558 
pid_Kd=450.720

####################################################################
###################### FANS & THERMISTORS ##########################
####################################################################
[thermistor NTC10K] #http://docs.ldomotors.com/en/guides/klipper-thermistor
temperature1: 0.0
resistance1: 32116.0
temperature2: 40.0
resistance2: 5309.0
temperature3: 80.0
resistance3: 1228.0

#  ____________________________________________________________________
#| HEATER |  HEAT pin |  TEMP pin | Accesories                         |
#| BED    | PA1       | (TB) PF3  | BED + thermistor                   |
#| HE0    | PA2       | (TO) PF4  | Watter pump PW + watter thermistr  |
#| HE1    | PA3       | (T1) PF5  | Electronic thermistor              |
#| HE2    | PB10      | (T2) PF6  | Chamber thermistor                 |
#| HE3    | PB11      | (T3) PF7  |                                    |   
# | ______|___________|___________|____________________________________|
#  _________________________________________________ 
# | FAN   |    PIN    | Accessories                 |
# |-------|-----------|-----------------------------|
# | FAN0  | PA8       | Water pump PWM              |
# | FAN1  | PE5       | Cooling Radiator            |
# | FAN2  | PD12      | Octopus driver              |
# | FAN3  | PD13      | White LED                   |
# | FAN4  | PD14      | UV - LED top + back plate   |
# | FAN5  | PD15      | UV - LED water tank         |
# | FAN6  | ALWAYS_ON | RPI - fan                   |
# | FAN7  | ALWAYS_ON | Electronic - fan            |
# | ______|___________|_____________________________|

[multi_pin led_uv]
pins: PD14, PD15

[output_pin LED-UV]
pin: multi_pin:led_uv

[output_pin LED-Chamber]
pin: PD13

#[output_pin FAN-EBB36]
#pin: EBB36: PA0

[fan]  #CPAP settings
pin: EBB36: PD3
kick_start_time: 0.05
off_below: 0.08
cycle_time: 0.0002

[heater_fan Driver]
pin: PD12
heater: extruder
heater_temp: 20
fan_speed: 0.7

[neopixel Neopixel]
pin:PB6
chain_count:13
color_order: GRB

[led_effect blue]
autostart:true
frame_rate:24
leds:
    neopixel:Neopixel
layers:
    static  0 1 top (0,0,1,0)

[heater_fan WaterPump] # Power for Water Pump 24V
pin: PA2
heater: extruder
heater_temp: 40.0
shutdown_speed: 0.0
kick_start_time: 0.1
# RPM monitoring:
tachometer_pin: ^PG12
tachometer_ppr: 3

[heater_fan Radiator]
pin: PE5
heater: extruder
heater_temp: 20

[temperature_sensor Chamber]
sensor_type: ATC Semitec 104GT-2 
sensor_pin: PF6

[temperature_sensor Watter]
sensor_type: NTC10K
sensor_pin: PF4

[temperature_sensor Electronic]
sensor_type: ATC Semitec 104GT-2 
sensor_pin: PF5

[temperature_sensor Octopus PRO]
sensor_type: temperature_mcu
sensor_mcu: mcu  

[temperature_sensor Raspberry Pi4]
sensor_type: temperature_host

[temperature_sensor CanBus]
sensor_type: temperature_mcu
sensor_mcu: EBB36

####################################################################
###################### END of manual config ########################
####################################################################

#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [beacon model default]
#*# model_coef = 1.3461887475383645,
#*# 	1.669324126805011,
#*# 	0.755351938000109,
#*# 	0.3135402081856062,
#*# 	0.3782377389401636,
#*# 	0.5903182539281734,
#*# 	-0.1713777710593022,
#*# 	-0.5665558213130618,
#*# 	0.29022728761739075,
#*# 	0.39608048747914354
#*# model_domain = 3.011556017270746e-07,3.31797046663502e-07
#*# model_range = 0.200000,5.000000
#*# model_temp = 40.142921
#*# model_offset = 0.00000
#*#
#*# [bed_mesh default]
#*# version = 1
#*# points =
#*# 	0.036728, 0.013869, 0.002434, 0.014806, 0.023861, 0.031989, 0.037627, 0.040769, 0.046009, 0.056269, 0.072685, 0.084757, 0.093379, 0.091641, 0.076353, 0.060845, 0.044264, 0.044799, 0.048294, 0.030693
#*# 	0.005587, -0.011251, -0.017468, -0.008099, 0.002654, 0.011677, 0.018587, 0.023758, 0.030188, 0.044027, 0.058854, 0.069655, 0.077020, 0.072181, 0.057949, 0.043069, 0.028614, 0.025566, 0.021780, 0.014301
#*# 	-0.023714, -0.029834, -0.034433, -0.023509, -0.011528, -0.003258, 0.004593, 0.012477, 0.019172, 0.030131, 0.044935, 0.057193, 0.064069, 0.057831, 0.044952, 0.029499, 0.012627, 0.012470, 0.016069, 0.007001
#*# 	-0.035412, -0.046262, -0.051977, -0.040003, -0.027655, -0.020215, -0.014717, -0.003148, 0.003043, 0.013141, 0.030021, 0.040227, 0.040932, 0.040439, 0.026753, 0.009394, -0.009043, -0.012352, -0.008179, -0.007770
#*# 	-0.051345, -0.062113, -0.066984, -0.052274, -0.041990, -0.036092, -0.025847, -0.016418, -0.013367, -0.003425, 0.007308, 0.015294, 0.026781, 0.024061, 0.012482, -0.004986, -0.025303, -0.028644, -0.027235, -0.030458
#*# 	-0.051155, -0.065359, -0.070732, -0.055357, -0.043188, -0.033953, -0.024894, -0.020960, -0.021657, -0.009722, 0.003446, 0.008992, 0.019925, 0.013164, -0.002774, -0.018380, -0.036323, -0.041844, -0.039330, -0.041773
#*# 	-0.059741, -0.072441, -0.074914, -0.058706, -0.044744, -0.033159, -0.025065, -0.027548, -0.023957, -0.015498, -0.005613, 0.006692, 0.013792, 0.014566, -0.003474, -0.016233, -0.041873, -0.048262, -0.043898, -0.045820
#*# 	-0.062584, -0.074768, -0.074688, -0.057418, -0.046454, -0.038382, -0.026240, -0.027066, -0.025768, -0.014946, -0.003582, 0.007742, 0.014832, 0.005960, -0.006853, -0.021700, -0.043253, -0.048648, -0.045602, -0.046436
#*# 	-0.054266, -0.069020, -0.070979, -0.052214, -0.039011, -0.024217, -0.018756, -0.015518, -0.022624, -0.010434, 0.003901, 0.012657, 0.017815, 0.012310, -0.005845, -0.022016, -0.041418, -0.051218, -0.050965, -0.048895
#*# 	-0.061532, -0.073388, -0.072208, -0.051158, -0.039697, -0.027918, -0.024144, -0.022851, -0.020932, -0.017944, -0.003044, 0.002014, 0.008563, 0.007549, -0.009686, -0.025000, -0.045196, -0.055225, -0.056233, -0.051482
#*# 	-0.052709, -0.062899, -0.061660, -0.043748, -0.030679, -0.023627, -0.020504, -0.018317, -0.022960, -0.009974, -0.002397, 0.003472, 0.009625, 0.008183, -0.007112, -0.025219, -0.043507, -0.052310, -0.053541, -0.049478
#*# 	-0.028643, -0.045504, -0.043977, -0.030121, -0.016457, -0.009449, -0.014498, -0.011459, -0.011056, -0.008541, -0.001202, 0.005900, 0.016179, 0.015598, 0.000415, -0.018798, -0.040373, -0.048471, -0.050787, -0.045480
#*# 	-0.012668, -0.030409, -0.028413, -0.016117, -0.005759, -0.000342, -0.001756, -0.000401, 0.001018, 0.007892, 0.015715, 0.019583, 0.028587, 0.028448, 0.011024, -0.009145, -0.026314, -0.036818, -0.039483, -0.036262
#*# 	-0.004078, -0.017943, -0.014570, 0.001567, 0.011699, 0.010250, 0.010894, 0.014492, 0.012493, 0.024193, 0.028712, 0.033782, 0.043597, 0.041865, 0.022488, 0.000924, -0.016672, -0.024534, -0.025539, -0.020243
#*# 	0.010601, -0.004038, -0.000542, 0.017776, 0.029874, 0.034934, 0.019886, 0.023720, 0.027033, 0.033455, 0.042963, 0.048543, 0.059347, 0.058993, 0.036582, 0.020507, 0.003411, -0.005904, -0.007026, -0.002001
#*# 	0.022815, 0.006690, 0.007311, 0.025210, 0.031712, 0.027598, 0.030664, 0.031396, 0.034334, 0.039879, 0.048170, 0.057385, 0.069560, 0.067028, 0.044958, 0.029971, 0.014639, 0.004851, 0.002544, 0.008785
#*# 	0.024849, 0.002064, 0.006412, 0.023184, 0.029005, 0.028121, 0.030467, 0.034548, 0.033538, 0.039220, 0.048922, 0.057525, 0.069487, 0.065783, 0.046486, 0.032263, 0.014001, 0.005802, 0.004029, 0.009853
#*# 	0.028997, 0.010148, 0.008988, 0.027843, 0.038470, 0.036222, 0.036700, 0.029003, 0.025305, 0.035028, 0.044622, 0.053638, 0.067453, 0.068571, 0.053856, 0.040652, 0.024132, 0.014278, 0.009728, 0.011983
#*# 	0.043298, 0.019138, 0.022365, 0.038825, 0.045424, 0.040830, 0.030265, 0.024375, 0.022373, 0.033021, 0.046643, 0.058676, 0.072407, 0.074655, 0.061864, 0.045286, 0.034783, 0.023168, 0.018423, 0.018365
#*# 	0.046208, 0.033541, 0.035260, 0.052316, 0.034979, 0.029061, 0.029353, 0.027598, 0.027129, 0.039396, 0.051040, 0.060720, 0.074355, 0.077321, 0.066725, 0.053676, 0.042935, 0.030379, 0.023615, 0.023424
#*# x_count = 20
#*# y_count = 20
#*# mesh_x_pps = 2
#*# mesh_y_pps = 2
#*# algo = bicubic
#*# tension = 0.2
#*# min_x = 10.0
#*# max_x = 380.0
#*# min_y = 51.0
#*# max_y = 350.0
#*#
#*# [axis_twist_compensation]
#*# z_compensations = -0.054357, 0.012732, 0.041625
#*# compensation_start_x = 40.0
#*# compensation_end_x = 350.0
