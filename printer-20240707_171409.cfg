#â—˜[include mmu/base/*.cfg]
#[include mmu/addons/mmu_erec_cutter.cfg]
#[include mmu/optional/client_macros.cfg]
#[include mmu/optional/mmu_ercf_compat.cfg]

####################################################################
############################## MCU #################################
####################################################################
[mcu]
#serial: /dev/serial/by-id/usb-Klipper_stm32f429xx_2F004C000951303439373431-if00
canbus_uuid:1f3a5bc4b712
[mcu EBB36]
serial: /dev/serial/by-id/usb-Klipper_stm32g0b1xx_560046001450425539393020-if00
#[mcu ERCF]
#canbus_uuid:e2e6ea2a9fde

####################################################################
########################### FUNCTIONS ##############################
####################################################################
[include fluidd.cfg]
[include K-ShakeTune/*.cfg]
[include macro.cfg]

[shaketune]
 result_folder: ~/printer_data/config/ShakeTune_results
#    The folder where the results will be stored. It will be created if it doesn't exist.
number_of_results_to_keep: 10
#    The number of results to keep in the result_folder. The oldest results will
#    be automatically deleted after each runs.
keep_raw_csv: False
#    If True, the raw CSV files will be kept in the result_folder alongside the
#    PNG graphs. If False, they will be deleted and only the graphs will be kept.
show_macros_in_webui: True
#    Mainsail and Fluidd doesn't create buttons for "system" macros that are not in the
#    printer.cfg file. If you want to see the macros in the webui, set this to True.
# timeout: 300
#    The maximum time in seconds to let Shake&Tune process the CSV files and generate the graphs.


#[include adxl.cfg]

[virtual_sdcard]
path: /home/hevort/printer_data/gcodes
on_error_gcode: CANCEL_PRINT

[display_status]

[exclude_object]

[gcode_arcs]  #Required for OrcaSlicer when using Z-hop. Orca does spiral wipes and needs G2/G3 to do so.
#resolution: 1.0

####################################################################
############################ PRINTER ###############################
####################################################################
[printer]
kinematics: corexy
max_velocity: 500
max_accel: 20000
max_z_velocity: 40
max_z_accel: 300
square_corner_velocity: 5

#[safe_z_home]
#home_xy_position: 195,150
#z_hop: 10
#z_hop_speed: 10

[pause_resume]
recover_velocity: 100

[input_shaper]
shaper_freq_x: 129.2  # per accelerometer
shaper_type_x: ei
shaper_freq_y: 130.8  # per accelerometer
shaper_type_y: 3hump_ei

####################################################################
############################ X AXIS ################################
####################################################################
#_____________________ XY Motor Mapping ____________________________
# 
#                           BACK  
#             Y_____________________________X
#              |                            | 
#              |                            | 
#              |                            | 
#          L   |                            |   R
#          E   |                            |   I
#          F   |                            |   G
#          T   |                            |   H
#              |                            |   T
#              |                            | 
#              |  0,0                       | 
#            X1|____________________________|Y1
#                         
#                         FRONT
#  ______________________________________________________________
# | DRIVE | STEP pin | DIR pin  | EN pin   | CS PIN   | END_STOP |
# |-------|----------|----------|----------|----------|----------|
# | X1    | PF11     | PG3      | PG5      | PC6      | CANBUS   |
# | X     | PG4      | PC1      | PA0      | PC7      |          |
# |_______|__________|__________|__________|__________|__________|

#____________________ MOTOR X __________________________
[stepper_x]           
step_pin: PG4
dir_pin: PC1
enable_pin: !PA0
microsteps: 16
rotation_distance: 40
endstop_pin: ^EBB36: PB6
position_endstop: 0
position_min: 0
position_max: 390
homing_speed: 150
full_steps_per_rotation: 400
homing_retract_dist: 0
homing_positive_dir: false

[tmc5160 stepper_x]
cs_pin: PC7
sense_resistor: 0.022
spi_software_miso_pin: PA6
spi_software_mosi_pin: PA7
spi_software_sclk_pin: PA5
interpolate: false
run_current: 1.2

#____________________ MOTOR X1 _________________________
[stepper_x1]           
step_pin: PF11
dir_pin: PG3
enable_pin: !PG5 
microsteps: 16
rotation_distance: 40
full_steps_per_rotation: 400


[tmc5160 stepper_x1]
cs_pin: PC6
sense_resistor: 0.022
spi_software_miso_pin: PA6
spi_software_mosi_pin: PA7
spi_software_sclk_pin: PA5
interpolate: false
run_current: 1.2

####################################################################
############################ Y AXIS ################################
####################################################################
# | DRIVE | STEP pin | DIR pin  | EN pin   | CS PIN   | END_STOP |
# |-------|----------|----------|----------|----------|----------|
# | Y1    | PF13     | PF12     | PF14     | PC4      |          |
# | Y     | PG0      | PG1      | PF15     | PD11     | PG11     |

#____________________ MOTOR Y __________________________
[stepper_y]           
step_pin: PG0
dir_pin: PG1
enable_pin: !PF15
microsteps: 16
rotation_distance: 40
endstop_pin: ^PG11
position_endstop: 0
position_min: 0
position_max: 350
homing_speed: 150
full_steps_per_rotation: 400
homing_retract_dist: 0
homing_positive_dir: false

[tmc5160 stepper_y]
cs_pin: PD11
sense_resistor: 0.022
spi_software_miso_pin: PA6
spi_software_mosi_pin: PA7
spi_software_sclk_pin: PA5
interpolate: false
run_current: 1.2

#____________________ MOTOR Y1 _________________________
[stepper_y1]           
step_pin: PF13
dir_pin: PF12
enable_pin: !PF14 
microsteps: 16
rotation_distance: 40
full_steps_per_rotation: 400


[tmc5160 stepper_y1]
cs_pin: PC4
sense_resistor: 0.022
spi_software_miso_pin: PA6
spi_software_mosi_pin: PA7
spi_software_sclk_pin: PA5
interpolate: false
run_current: 1.2

####################################################################
############################ Z AXIS ################################
####################################################################
# | DRIVE | STEP pin | DIR pin  | EN pin   | CS PIN   | END_STOP |
# |-------|----------|----------|----------|----------|----------|
# | Z     | PF9      | PF10     | PG2      | PF2      | PG12     |
# | Z1    | PC13     | PF0      | PF1      | PE4      | PD13     |
# | Z2    | PE2      | PE3      | PD4      | PE1      | PD14     |

#____________________ MOTOR Z  _______________________
[stepper_z]         
step_pin: PF9
dir_pin: PF10
enable_pin: !PG2

microsteps: 32
rotation_distance: 4 				
full_steps_per_rotation: 200
endstop_pin: probe:z_virtual_endstop
position_max: 350
position_min: -2 #Using negative value will allow bed to go past 0 to reach Z Probe in case of unlevelled bed.
homing_speed: 20
homing_retract_dist: 0 # beacon needs this to be set to 0

[tmc5160 stepper_z]
cs_pin: PF2
spi_software_sclk_pin: PA5
spi_software_mosi_pin: PA7
spi_software_miso_pin: PA6
interpolate: false
run_current: 1.6
#____________________ MOTOR Z1 _______________________
[stepper_z1]          
step_pin: PC13
dir_pin: PF0
enable_pin: !PF1
microsteps: 32
rotation_distance: 4 				
full_steps_per_rotation: 200

[tmc5160 stepper_z1]
cs_pin: PE4
spi_software_sclk_pin: PA5
spi_software_mosi_pin: PA7
spi_software_miso_pin: PA6
interpolate: false
run_current: 1.6
#____________________ MOTOR Z2 _______________________
[stepper_z2]
step_pin: PE2
dir_pin: PE3
enable_pin: !PD4
microsteps: 32
rotation_distance: 4 				
full_steps_per_rotation: 200

[tmc5160 stepper_z2]
cs_pin: PE1
spi_software_sclk_pin: PA5
spi_software_mosi_pin: PA7
spi_software_miso_pin: PA6
interpolate: false
run_current: 1.6

#____________________ ACTIVE - Beacon3D Eddy Current _______________
[beacon]
serial: /dev/serial/by-id/usb-Beacon_Beacon_RevD_71FC66C74E4B333448202020FF0A2035-if00
x_offset: 0         # update with offset from nozzle on your machine
y_offset: 20.5        # update with offset from nozzle on your machine
mesh_main_direction: x
mesh_runs: 2
home_xy_position: 195,195
home_z_hop: 10
home_z_hop_speed: 10
home_xy_move_speed: 300
speed: 10         # Z probing dive speed.
lift_speed: 15     # Z probing lift speed.

#____________________ ACTIVE - SELF LEVELLING (Z_Tilt) _____________
[z_tilt]
z_positions: 
    -22.940, -10.300
    195.768, 402.910
    414.476, -10.300

points:
	20,5
	20,300
    370,300
    #195,300
	370,5       

speed: 300
horizontal_move_z: 15
retries: 3  #   Number of times to retry if the probed points aren't within a givin tolerance
retry_tolerance: 0.07

[axis_twist_compensation]
 speed: 80
#   The speed (in mm/s) of non-probing moves during the calibration.
#   The default is 50.
horizontal_move_z: 5
#   The height (in mm) that the head should be commanded to move to
#   just prior to starting a probe operation. The default is 5.
calibrate_start_x: 40
#   Defines the minimum X coordinate of the calibration
#   This should be the X coordinate that positions the nozzle at the starting               !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
#   calibration position. This parameter must be provided.
calibrate_end_x: 350
#   Defines the maximum X coordinate of the calibration
#   This should be the X coordinate that positions the nozzle at the ending
#   calibration position. This parameter must be provided.
calibrate_y: 180
#   Defines the Y coordinate of the calibration
#   This should be the Y coordinate that positions the nozzle during the
#   calibration process. This parameter must be provided and is recommended to
#   be near the center of the bed

#____________________ ACTIVE - BED MESH ____________________________
[bed_mesh]
algorithm: bicubic
bicubic_tension: 0.2
speed: 500
horizontal_move_z: 2
mesh_min: 10, 21 #Probe position
mesh_max: 380,350 
probe_count: 20,20
fade_start: 1
fade_end: 5

##################################################################
########################## EXTRUDER ##############################
##################################################################


#____________________ ACTIVE - Extruder On Drive 6 ####_________________
[extruder]
step_pin: EBB36: PD0
dir_pin: !EBB36: PD1
enable_pin: !EBB36: PD2

microsteps: 16
full_steps_per_rotation: 200
rotation_distance: 4.4548195847022
nozzle_diameter: 0.400
filament_diameter: 1.750
max_extrude_cross_section:5

#____________________ PT1000 CanBus _____________
heater_pin: EBB36: PB13
sensor_type: PT1000    
sensor_pin: EBB36: PA3
pullup_resistor: 2200

control: pid
pid_Kp=21.110 
pid_Ki=2.070 
pid_Kd=53.829

min_temp: 10
max_temp: 350
min_extrude_temp: 10

pressure_advance = 0.011
max_extrude_only_distance: 150.0

[tmc2209 extruder]
uart_pin: EBB36: PA15
interpolate: false
run_current: 0.800
sense_resistor: 0.110

[firmware_retraction]
retract_length: 0.5
#   The length of filament (in mm) to retract when G10 is activated,
#   and to unretract when G11 is activated (but see
#   unretract_extra_length below). The default is 0 mm.
retract_speed: 50
#   The speed of retraction, in mm/s. The default is 20 mm/s.
unretract_extra_length: 0
#   The length (in mm) of *additional* filament to add when
#   unretracting.
unretract_speed: 50
#   The speed of unretraction, in mm/s. The default is 10 mm/s.

####################################################################
############################ BED ###################################
####################################################################
[heater_bed]
heater_pin: PA1
sensor_type: Generic 3950
sensor_pin: PF3
min_temp: 0
max_temp: 110

control: pid
pid_Kp=67.905 
pid_Ki=2.558 
pid_Kd=450.720

####################################################################
###################### FANS & THERMISTORS ##########################
####################################################################
[thermistor NTC10K] #http://docs.ldomotors.com/en/guides/klipper-thermistor
temperature1: 0.0
resistance1: 32116.0
temperature2: 40.0
resistance2: 5309.0
temperature3: 80.0
resistance3: 1228.0

#  ____________________________________________________________________
#| HEATER |  HEAT pin |  TEMP pin | Accesories                         |
#| BED    | PA1       | (TB) PF3  | BED + thermistor                   |
#| HE0    | PA2       | (TO) PF4  | Watter pump PW + watter thermistr  |
#| HE1    | PA3       | (T1) PF5  | Electronic thermistor              |
#| HE2    | PB10      | (T2) PF6  | Chamber thermistor                 |
#| HE3    | PB11      | (T3) PF7  |                                    |   
# | ______|___________|___________|____________________________________|
#  _________________________________________________ 
# | FAN   |    PIN    | Accessories                 |
# |-------|-----------|-----------------------------|
# | FAN0  | PA8       | Water pump PWM              |
# | FAN1  | PE5       | Cooling Radiator            |
# | FAN2  | PD12      | Octopus driver              |
# | FAN3  | PD13      | White LED                   |
# | FAN4  | PD14      | UV - LED top + back plate   |
# | FAN5  | PD15      | UV - LED water tank         |
# | FAN6  | ALWAYS_ON | RPI - fan                   |
# | FAN7  | ALWAYS_ON | Electronic - fan            |
# | ______|___________|_____________________________|

[multi_pin led_uv]
pins: PD14, PD15

[output_pin LED-UV]
pin: multi_pin:led_uv

[output_pin LED-Chamber]
pin: PD13

#[output_pin FAN-EBB36]
#pin: EBB36: PA0

[fan]  #CPAP settings
pin: EBB36: PD3
kick_start_time: 0.05
off_below: 0.08
cycle_time: 0.0002

[heater_fan Driver]
pin: PD12
heater: extruder
heater_temp: 20

[neopixel Neopixel]
pin:PB6
chain_count:13
color_order: GRB

[led_effect blue]
autostart:true
frame_rate:24
leds:
    neopixel:Neopixel
layers:
    static  0 1 top (0,0,1,0)

[heater_fan WaterPump] # Power for Water Pump 24V
pin: PA2
heater: extruder
heater_temp: 40.0
shutdown_speed: 0.0
kick_start_time: 0.1
# RPM monitoring:
tachometer_pin: ^PG12
tachometer_ppr: 3

[heater_fan Radiator]
pin: PE5
heater: extruder
heater_temp: 30

[fan_generic Exhaust]
pin: PA8

[temperature_sensor Chamber]
sensor_type: ATC Semitec 104GT-2 
sensor_pin: PF6

[temperature_sensor Watter]
sensor_type: NTC10K
sensor_pin: PF4

[temperature_sensor Electronic]
sensor_type: ATC Semitec 104GT-2 
sensor_pin: PF5

[temperature_sensor Octopus PRO]
sensor_type: temperature_mcu
sensor_mcu: mcu  

[temperature_sensor Raspberry Pi4]
sensor_type: temperature_host

[temperature_sensor CanBus]
sensor_type: temperature_mcu
sensor_mcu: EBB36

####################################################################
###################### END of manual config ########################
####################################################################

#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [beacon model default]
#*# model_coef = 1.3552984581670895,
#*# 	  1.673994575977155,
#*# 	  0.746267284660211,
#*# 	  0.3366897904570369,
#*# 	  0.4257715898383162,
#*# 	  0.47888097141753455,
#*# 	  -0.24399285136674118,
#*# 	  -0.39949583237000647,
#*# 	  0.31623077089642865,
#*# 	  0.31230898527188744
#*# model_domain = 3.021766569798853e-07,3.3188590268733473e-07
#*# model_range = 0.200000,5.000000
#*# model_temp = 40.183502
#*# model_offset = 0.00000
#*#
#*# [bed_mesh default]
#*# version = 1
#*# points =
#*# 	  0.114840, 0.079100, 0.056562, 0.054894, 0.053354, 0.049655, 0.047655, 0.043976, 0.040029, 0.047425, 0.063938, 0.079199, 0.087289, 0.089902, 0.080372, 0.070599, 0.061005, 0.063242, 0.078710, 0.066541
#*# 	  0.086343, 0.056207, 0.037885, 0.037010, 0.035050, 0.032057, 0.028435, 0.027136, 0.025142, 0.034509, 0.052113, 0.064464, 0.074025, 0.072983, 0.063653, 0.055638, 0.043176, 0.044360, 0.051691, 0.045497
#*# 	  0.069679, 0.043501, 0.027261, 0.023758, 0.024257, 0.020703, 0.020601, 0.019038, 0.015933, 0.026054, 0.044409, 0.056553, 0.065535, 0.060087, 0.049988, 0.039031, 0.028087, 0.035750, 0.040651, 0.038582
#*# 	  0.054598, 0.032682, 0.014646, 0.014613, 0.013241, 0.010301, 0.003925, 0.007763, 0.004448, 0.012857, 0.030178, 0.042839, 0.050815, 0.045858, 0.037283, 0.013855, 0.007176, 0.006188, 0.018954, 0.026937
#*# 	  0.047710, 0.021995, 0.004712, 0.005625, 0.006249, -0.001184, -0.004202, -0.002726, -0.006002, 0.000604, 0.007197, 0.018915, 0.032219, 0.033240, 0.020458, 0.007813, -0.009348, -0.004014, 0.001490, 0.005511
#*# 	  0.051253, 0.023222, 0.006006, 0.006365, 0.006286, 0.004468, 0.001019, -0.001526, -0.009467, -0.003678, 0.011323, 0.013727, 0.030829, 0.020612, 0.012224, -0.002457, -0.014955, -0.015413, -0.005598, -0.001865
#*# 	  0.045207, 0.020254, 0.005371, 0.007619, 0.008083, 0.005363, 0.004920, -0.003252, -0.014962, -0.010140, 0.002167, 0.015080, 0.027726, 0.025683, 0.013669, 0.000939, -0.017207, -0.020050, -0.011816, -0.006512
#*# 	  0.050370, 0.022881, 0.010897, 0.011022, 0.012028, 0.009499, 0.009266, 0.000282, -0.012655, -0.004573, 0.005393, 0.018964, 0.022640, 0.023433, 0.012745, 0.000264, -0.015859, -0.019033, -0.010193, -0.004270
#*# 	  0.059116, 0.029952, 0.016790, 0.019931, 0.016808, 0.022374, 0.019312, 0.001034, -0.007766, -0.002008, 0.013633, 0.024176, 0.031898, 0.026605, 0.014608, -0.000715, -0.015940, -0.021552, -0.015796, -0.007976
#*# 	  0.062943, 0.032118, 0.018205, 0.023174, 0.025989, 0.019847, 0.019012, 0.007947, -0.005973, 0.002148, 0.005322, 0.015585, 0.026424, 0.029763, 0.016410, 0.001196, -0.013302, -0.021728, -0.014591, -0.005928
#*# 	  0.072229, 0.044017, 0.034044, 0.032755, 0.028740, 0.031774, 0.014309, 0.006722, 0.000242, 0.005174, 0.011526, 0.018772, 0.028731, 0.028430, 0.019567, 0.001520, -0.014867, -0.016527, -0.011715, -0.002521
#*# 	  0.100621, 0.062816, 0.053155, 0.053060, 0.040924, 0.044595, 0.026807, 0.019550, 0.005556, 0.008533, 0.020307, 0.028054, 0.040080, 0.039555, 0.026737, 0.008569, -0.007615, -0.013067, -0.006093, 0.000602
#*# 	  0.122319, 0.080718, 0.067087, 0.067832, 0.057432, 0.052983, 0.046267, 0.039139, 0.029220, 0.032239, 0.036621, 0.041575, 0.053764, 0.053782, 0.037714, 0.019312, 0.005227, -0.000906, 0.002644, 0.013086
#*# 	  0.137048, 0.093130, 0.081417, 0.088183, 0.080510, 0.079013, 0.065418, 0.048127, 0.040144, 0.044783, 0.054269, 0.058567, 0.070540, 0.069466, 0.052762, 0.031557, 0.018704, 0.015749, 0.018904, 0.027603
#*# 	  0.154865, 0.107408, 0.098285, 0.107909, 0.097319, 0.099368, 0.076817, 0.066224, 0.052383, 0.060689, 0.067340, 0.074444, 0.085993, 0.087016, 0.065446, 0.049990, 0.037541, 0.031786, 0.037052, 0.046235
#*# 	  0.168630, 0.122252, 0.109973, 0.110259, 0.095112, 0.103287, 0.087827, 0.071590, 0.064762, 0.068403, 0.076941, 0.085168, 0.097927, 0.096785, 0.076968, 0.062609, 0.050084, 0.042861, 0.048296, 0.059362
#*# 	  0.176816, 0.129726, 0.116309, 0.115380, 0.107387, 0.098745, 0.094301, 0.079586, 0.069107, 0.070772, 0.080902, 0.090608, 0.102699, 0.099905, 0.083108, 0.068613, 0.054565, 0.048414, 0.053027, 0.062581
#*# 	  0.179965, 0.138683, 0.123352, 0.122077, 0.106258, 0.111257, 0.092950, 0.078593, 0.062845, 0.068963, 0.078904, 0.088097, 0.102174, 0.104824, 0.092758, 0.078619, 0.065061, 0.057410, 0.060680, 0.068382
#*# 	  0.192150, 0.151087, 0.139074, 0.135092, 0.122871, 0.109454, 0.092215, 0.078394, 0.067415, 0.072455, 0.085124, 0.095689, 0.108077, 0.110701, 0.100372, 0.083595, 0.073169, 0.063919, 0.065720, 0.070225
#*# 	  0.196014, 0.171741, 0.159033, 0.146435, 0.128161, 0.110623, 0.098456, 0.086434, 0.076690, 0.080234, 0.093670, 0.102517, 0.113979, 0.116623, 0.106285, 0.091574, 0.085176, 0.073163, 0.073056, 0.076031
#*# x_count = 20
#*# y_count = 20
#*# mesh_x_pps = 2
#*# mesh_y_pps = 2
#*# algo = bicubic
#*# tension = 0.2
#*# min_x = 10.0
#*# max_x = 380.0
#*# min_y = 51.0
#*# max_y = 350.0
#*#
#*# [axis_twist_compensation]
#*# z_compensations = -0.054357, 0.012732, 0.041625
#*# compensation_start_x = 40.0
#*# compensation_end_x = 350.0
