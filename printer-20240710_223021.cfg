#â—˜[include mmu/base/*.cfg]
#[include mmu/addons/mmu_erec_cutter.cfg]
#[include mmu/optional/client_macros.cfg]
#[include mmu/optional/mmu_ercf_compat.cfg]

####################################################################
############################## MCU #################################
####################################################################
[mcu]
#serial: /dev/serial/by-id/usb-Klipper_stm32f429xx_2F004C000951303439373431-if00
canbus_uuid:1f3a5bc4b712
[mcu EBB36]
serial: /dev/serial/by-id/usb-Klipper_stm32g0b1xx_560046001450425539393020-if00
#[mcu ERCF]
#canbus_uuid:e2e6ea2a9fde

####################################################################
########################### FUNCTIONS ##############################
####################################################################
[include fluidd.cfg]
[include K-ShakeTune/*.cfg]
[include macro.cfg]

[shaketune]
 result_folder: ~/printer_data/config/ShakeTune_results
#    The folder where the results will be stored. It will be created if it doesn't exist.
number_of_results_to_keep: 10
#    The number of results to keep in the result_folder. The oldest results will
#    be automatically deleted after each runs.
keep_raw_csv: False
#    If True, the raw CSV files will be kept in the result_folder alongside the
#    PNG graphs. If False, they will be deleted and only the graphs will be kept.
show_macros_in_webui: True
#    Mainsail and Fluidd doesn't create buttons for "system" macros that are not in the
#    printer.cfg file. If you want to see the macros in the webui, set this to True.
# timeout: 300
#    The maximum time in seconds to let Shake&Tune process the CSV files and generate the graphs.


#[include adxl.cfg]

[virtual_sdcard]
path: /home/hevort/printer_data/gcodes
on_error_gcode: CANCEL_PRINT

[display_status]

[exclude_object]

[gcode_arcs]  #Required for OrcaSlicer when using Z-hop. Orca does spiral wipes and needs G2/G3 to do so.
#resolution: 1.0

####################################################################
############################ PRINTER ###############################
####################################################################
[printer]
kinematics: corexy
max_velocity: 500
max_accel: 20000
max_z_velocity: 40
max_z_accel: 300
square_corner_velocity: 5

#[safe_z_home]
#home_xy_position: 195,150
#z_hop: 10
#z_hop_speed: 10

[pause_resume]
recover_velocity: 100

[input_shaper]
shaper_freq_x: 119  # per accelerometer
shaper_type_x: mzv
shaper_freq_y: 144  # per accelerometer
shaper_type_y: 3hump_ei

####################################################################
############################ X AXIS ################################
####################################################################
#_____________________ XY Motor Mapping ____________________________
# 
#                           BACK  
#             Y_____________________________X
#              |                            | 
#              |                            | 
#              |                            | 
#          L   |                            |   R
#          E   |                            |   I
#          F   |                            |   G
#          T   |                            |   H
#              |                            |   T
#              |                            | 
#              |  0,0                       | 
#            X1|____________________________|Y1
#                         
#                         FRONT
#  ______________________________________________________________
# | DRIVE | STEP pin | DIR pin  | EN pin   | CS PIN   | END_STOP |
# |-------|----------|----------|----------|----------|----------|
# | X1    | PF11     | PG3      | PG5      | PC6      | CANBUS   |
# | X     | PG4      | PC1      | PA0      | PC7      |          |
# |_______|__________|__________|__________|__________|__________|

#____________________ MOTOR X __________________________
[stepper_x]           
step_pin: PG4
dir_pin: PC1
enable_pin: !PA0
microsteps: 16
rotation_distance: 40
endstop_pin: ^EBB36: PB6
position_endstop: 0
position_min: 0
position_max: 390
homing_speed: 150
full_steps_per_rotation: 400
homing_retract_dist: 0
homing_positive_dir: false

[tmc5160 stepper_x]
cs_pin: PC7
sense_resistor: 0.022
spi_software_miso_pin: PA6
spi_software_mosi_pin: PA7
spi_software_sclk_pin: PA5
interpolate: false
run_current: 1.2

#____________________ MOTOR X1 _________________________
[stepper_x1]           
step_pin: PF11
dir_pin: PG3
enable_pin: !PG5 
microsteps: 16
rotation_distance: 40
full_steps_per_rotation: 400


[tmc5160 stepper_x1]
cs_pin: PC6
sense_resistor: 0.022
spi_software_miso_pin: PA6
spi_software_mosi_pin: PA7
spi_software_sclk_pin: PA5
interpolate: false
run_current: 1.2

####################################################################
############################ Y AXIS ################################
####################################################################
# | DRIVE | STEP pin | DIR pin  | EN pin   | CS PIN   | END_STOP |
# |-------|----------|----------|----------|----------|----------|
# | Y1    | PF13     | PF12     | PF14     | PC4      |          |
# | Y     | PG0      | PG1      | PF15     | PD11     | PG11     |

#____________________ MOTOR Y __________________________
[stepper_y]           
step_pin: PG0
dir_pin: PG1
enable_pin: !PF15
microsteps: 16
rotation_distance: 40
endstop_pin: ^PG11
position_endstop: 0
position_min: 0
position_max: 380
homing_speed: 150
full_steps_per_rotation: 400
homing_retract_dist: 0
homing_positive_dir: false

[tmc5160 stepper_y]
cs_pin: PD11
sense_resistor: 0.022
spi_software_miso_pin: PA6
spi_software_mosi_pin: PA7
spi_software_sclk_pin: PA5
interpolate: false
run_current: 1.2

#____________________ MOTOR Y1 _________________________
[stepper_y1]           
step_pin: PF13
dir_pin: PF12
enable_pin: !PF14 
microsteps: 16
rotation_distance: 40
full_steps_per_rotation: 400


[tmc5160 stepper_y1]
cs_pin: PC4
sense_resistor: 0.022
spi_software_miso_pin: PA6
spi_software_mosi_pin: PA7
spi_software_sclk_pin: PA5
interpolate: false
run_current: 1.2

####################################################################
############################ Z AXIS ################################
####################################################################
# | DRIVE | STEP pin | DIR pin  | EN pin   | CS PIN   | END_STOP |
# |-------|----------|----------|----------|----------|----------|
# | Z     | PF9      | PF10     | PG2      | PF2      | PG12     |
# | Z1    | PC13     | PF0      | PF1      | PE4      | PD13     |
# | Z2    | PE2      | PE3      | PD4      | PE1      | PD14     |

#____________________ MOTOR Z  _______________________
[stepper_z]         
step_pin: PF9
dir_pin: PF10
enable_pin: !PG2

microsteps: 32
rotation_distance: 4 				
full_steps_per_rotation: 200
endstop_pin: probe:z_virtual_endstop
position_max: 350
position_min: -2 #Using negative value will allow bed to go past 0 to reach Z Probe in case of unlevelled bed.
homing_speed: 20
homing_retract_dist: 0 # beacon needs this to be set to 0

[tmc5160 stepper_z]
cs_pin: PF2
spi_software_sclk_pin: PA5
spi_software_mosi_pin: PA7
spi_software_miso_pin: PA6
interpolate: false
run_current: 1.6
#____________________ MOTOR Z1 _______________________
[stepper_z1]          
step_pin: PC13
dir_pin: PF0
enable_pin: !PF1
microsteps: 32
rotation_distance: 4 				
full_steps_per_rotation: 200

[tmc5160 stepper_z1]
cs_pin: PE4
spi_software_sclk_pin: PA5
spi_software_mosi_pin: PA7
spi_software_miso_pin: PA6
interpolate: false
run_current: 1.6
#____________________ MOTOR Z2 _______________________
[stepper_z2]
step_pin: PE2
dir_pin: PE3
enable_pin: !PD4
microsteps: 32
rotation_distance: 4 				
full_steps_per_rotation: 200

[tmc5160 stepper_z2]
cs_pin: PE1
spi_software_sclk_pin: PA5
spi_software_mosi_pin: PA7
spi_software_miso_pin: PA6
interpolate: false
run_current: 1.6

#____________________ ACTIVE - Beacon3D Eddy Current _______________
[beacon]
serial: /dev/serial/by-id/usb-Beacon_Beacon_RevD_71FC66C74E4B333448202020FF0A2035-if00
x_offset: 0         # update with offset from nozzle on your machine
y_offset: 20.5        # update with offset from nozzle on your machine
mesh_main_direction: x
mesh_runs: 2
home_xy_position: 195,195
home_z_hop: 10
home_z_hop_speed: 10
home_xy_move_speed: 300
speed: 10         # Z probing dive speed.
lift_speed: 15     # Z probing lift speed.

#____________________ ACTIVE - SELF LEVELLING (Z_Tilt) _____________
[z_tilt]
z_positions: 
    -22.940, -10.300
    195.768, 402.910
    414.476, -10.300

points:
	20,0
	20,320
    370,320
    #195.77,320
	370,0       

speed: 300
horizontal_move_z: 15
retries: 3  #   Number of times to retry if the probed points aren't within a givin tolerance
retry_tolerance: 0.05

[axis_twist_compensation]
 speed: 80
#   The speed (in mm/s) of non-probing moves during the calibration.
#   The default is 50.
horizontal_move_z: 5
#   The height (in mm) that the head should be commanded to move to
#   just prior to starting a probe operation. The default is 5.
calibrate_start_x: 20
#   Defines the minimum X coordinate of the calibration
#   This should be the X coordinate that positions the nozzle at the starting               !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
#   calibration position. This parameter must be provided.
calibrate_end_x: 370
#   Defines the maximum X coordinate of the calibration
#   This should be the X coordinate that positions the nozzle at the ending
#   calibration position. This parameter must be provided.
calibrate_y: 180
#   Defines the Y coordinate of the calibration
#   This should be the Y coordinate that positions the nozzle during the
#   calibration process. This parameter must be provided and is recommended to
#   be near the center of the bed

#____________________ ACTIVE - BED MESH ____________________________
[bed_mesh]
algorithm: bicubic
bicubic_tension: 0.2
speed: 500
horizontal_move_z: 2
mesh_min: 20, 21 #Probe position
mesh_max: 370,340 
probe_count: 20,20
fade_start: 1
fade_end: 5

##################################################################
########################## EXTRUDER ##############################
##################################################################


#____________________ ACTIVE - Extruder On Drive 6 ####_________________
[extruder]
step_pin: EBB36: PD0
dir_pin: !EBB36: PD1
enable_pin: !EBB36: PD2

microsteps: 16
full_steps_per_rotation: 200
rotation_distance: 4.4548195847022
nozzle_diameter: 0.400
filament_diameter: 1.750
max_extrude_cross_section:5

#____________________ PT1000 CanBus _____________
heater_pin: EBB36: PB13
sensor_type: PT1000    
sensor_pin: EBB36: PA3
pullup_resistor: 2200

control: pid
pid_Kp=21.110 
pid_Ki=2.070 
pid_Kd=53.829

min_temp: 10
max_temp: 350
min_extrude_temp: 10

pressure_advance = 0.011
max_extrude_only_distance: 150.0

[tmc2209 extruder]
uart_pin: EBB36: PA15
interpolate: false
run_current: 0.800
sense_resistor: 0.110

[firmware_retraction]
retract_length: 0.5
#   The length of filament (in mm) to retract when G10 is activated,
#   and to unretract when G11 is activated (but see
#   unretract_extra_length below). The default is 0 mm.
retract_speed: 50
#   The speed of retraction, in mm/s. The default is 20 mm/s.
unretract_extra_length: 0
#   The length (in mm) of *additional* filament to add when
#   unretracting.
unretract_speed: 50
#   The speed of unretraction, in mm/s. The default is 10 mm/s.

####################################################################
############################ BED ###################################
####################################################################
[heater_bed]
heater_pin: PA1
sensor_type: Generic 3950
sensor_pin: PF3
min_temp: 0
max_temp: 110

control: pid
pid_Kp=67.905 
pid_Ki=2.558 
pid_Kd=450.720

####################################################################
###################### FANS & THERMISTORS ##########################
####################################################################
[thermistor NTC10K] #http://docs.ldomotors.com/en/guides/klipper-thermistor
temperature1: 0.0
resistance1: 32116.0
temperature2: 40.0
resistance2: 5309.0
temperature3: 80.0
resistance3: 1228.0

#  ____________________________________________________________________
#| HEATER |  HEAT pin |  TEMP pin | Accesories                         |
#| BED    | PA1       | (TB) PF3  | BED + thermistor                   |
#| HE0    | PA2       | (TO) PF4  | Watter pump PW + watter thermistr  |
#| HE1    | PA3       | (T1) PF5  | Electronic thermistor              |
#| HE2    | PB10      | (T2) PF6  | Chamber thermistor                 |
#| HE3    | PB11      | (T3) PF7  |                                    |   
# | ______|___________|___________|____________________________________|
#  _________________________________________________ 
# | FAN   |    PIN    | Accessories                 |
# |-------|-----------|-----------------------------|
# | FAN0  | PA8       | Water pump PWM              |
# | FAN1  | PE5       | Cooling Radiator            |
# | FAN2  | PD12      | Octopus driver              |
# | FAN3  | PD13      | White LED                   |
# | FAN4  | PD14      | UV - LED top + back plate   |
# | FAN5  | PD15      | UV - LED water tank         |
# | FAN6  | ALWAYS_ON | RPI - fan                   |
# | FAN7  | ALWAYS_ON | Electronic - fan            |
# | ______|___________|_____________________________|

[multi_pin led_uv]
pins: PD14, PD15

[output_pin LED-UV]
pin: multi_pin:led_uv

[output_pin LED-Chamber]
pin: PD13

#[output_pin FAN-EBB36]
#pin: EBB36: PA0

[fan]  #CPAP settings
pin: EBB36: PD3
kick_start_time: 0.05
off_below: 0.08
cycle_time: 0.0002

[heater_fan Driver]
pin: PD12
heater: extruder
heater_temp: 20

[neopixel Neopixel]
pin:PB6
chain_count:13
color_order: GRB

[led_effect blue]
autostart:true
frame_rate:24
leds:
    neopixel:Neopixel
layers:
    static  0 1 top (0,0,1,0)

[heater_fan WaterPump] # Power for Water Pump 24V
pin: PA2
heater: extruder
heater_temp: 40.0
shutdown_speed: 0.0
kick_start_time: 0.1
# RPM monitoring:
tachometer_pin: ^PG12
tachometer_ppr: 3

[heater_fan Radiator]
pin: PE5
heater: extruder
heater_temp: 30

[fan_generic Exhaust]
pin: PA8

[temperature_sensor Chamber]
sensor_type: ATC Semitec 104GT-2 
sensor_pin: PF6

[temperature_sensor Watter]
sensor_type: NTC10K
sensor_pin: PF4

[temperature_sensor Electronic]
sensor_type: ATC Semitec 104GT-2 
sensor_pin: PF5

[temperature_sensor Octopus PRO]
sensor_type: temperature_mcu
sensor_mcu: mcu  

[temperature_sensor Raspberry Pi4]
sensor_type: temperature_host

[temperature_sensor CanBus]
sensor_type: temperature_mcu
sensor_mcu: EBB36

####################################################################
###################### END of manual config ########################
####################################################################

#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [beacon model default]
#*# model_coef = 1.3856912826688585,
#*# 	  1.7105365024665036,
#*# 	  0.8002702515525348,
#*# 	  0.3941471048986567,
#*# 	  0.24695876889812626,
#*# 	  0.23449762925429238,
#*# 	  0.00032710241690994517,
#*# 	  -0.06423162652535533,
#*# 	  0.1663647333169578,
#*# 	  0.12731042329449768
#*# model_domain = 3.098142630473893e-07,3.3237030325720287e-07
#*# model_range = 0.200000,5.000000
#*# model_temp = 42.966168
#*# model_offset = 0.00000
#*#
#*# [bed_mesh default]
#*# version = 1
#*# points =
#*# 	  0.151713, 0.121032, 0.106766, 0.107602, 0.108897, 0.107095, 0.103493, 0.097022, 0.096551, 0.102599, 0.118805, 0.134304, 0.151582, 0.162731, 0.160549, 0.158313, 0.157609, 0.163316, 0.176350, 0.198097
#*# 	  0.137418, 0.108494, 0.097670, 0.101056, 0.100953, 0.099509, 0.095654, 0.091047, 0.090235, 0.096858, 0.113204, 0.129662, 0.146559, 0.156669, 0.156790, 0.151675, 0.152732, 0.158597, 0.176300, 0.198506
#*# 	  0.125848, 0.097840, 0.088953, 0.090778, 0.090257, 0.086947, 0.084363, 0.078989, 0.079447, 0.083599, 0.101745, 0.118168, 0.133862, 0.142645, 0.142086, 0.138948, 0.139376, 0.147792, 0.165127, 0.187836
#*# 	  0.106839, 0.081275, 0.072662, 0.071981, 0.071788, 0.068545, 0.066351, 0.062431, 0.061710, 0.069399, 0.086330, 0.103149, 0.118446, 0.126124, 0.127013, 0.121665, 0.122751, 0.130567, 0.148981, 0.170238
#*# 	  0.085495, 0.063464, 0.053019, 0.054329, 0.052821, 0.048462, 0.046720, 0.043861, 0.042566, 0.049591, 0.067733, 0.082889, 0.099492, 0.109877, 0.110406, 0.105085, 0.104773, 0.112916, 0.131275, 0.152857
#*# 	  0.065097, 0.039774, 0.030025, 0.032013, 0.029715, 0.023663, 0.020831, 0.016680, 0.016188, 0.022830, 0.039881, 0.056188, 0.071381, 0.082275, 0.083332, 0.077135, 0.078517, 0.083270, 0.102265, 0.122746
#*# 	  0.052200, 0.023955, 0.014814, 0.017305, 0.015041, 0.009165, 0.005217, 0.000071, -0.002108, 0.005187, 0.021124, 0.037094, 0.055723, 0.064576, 0.065943, 0.059659, 0.058709, 0.064108, 0.082029, 0.103089
#*# 	  0.040580, 0.014700, 0.008444, 0.009488, 0.008739, 0.004896, -0.000207, -0.008733, -0.011623, -0.003456, 0.009108, 0.026053, 0.045279, 0.055446, 0.056122, 0.053436, 0.048593, 0.052706, 0.068705, 0.089186
#*# 	  0.036235, 0.012614, 0.007143, 0.009420, 0.006314, 0.002864, -0.002447, -0.010183, -0.015340, -0.004726, 0.010960, 0.026824, 0.044737, 0.051839, 0.051958, 0.050634, 0.044245, 0.047759, 0.064309, 0.084791
#*# 	  0.036634, 0.012003, 0.007120, 0.008828, 0.005869, 0.004763, 0.001081, -0.007595, -0.012353, -0.005147, 0.010484, 0.027671, 0.044395, 0.052082, 0.050078, 0.045955, 0.042241, 0.045383, 0.057863, 0.077345
#*# 	  0.033298, 0.008797, 0.004109, 0.006673, 0.004243, 0.001429, -0.003098, -0.011211, -0.016917, -0.007593, 0.006738, 0.021404, 0.036892, 0.047620, 0.045105, 0.039795, 0.036846, 0.037847, 0.050767, 0.069959
#*# 	  0.042847, 0.020480, 0.013204, 0.013095, 0.008963, 0.005037, -0.000840, -0.006716, -0.010169, -0.003280, 0.007009, 0.019657, 0.035877, 0.044768, 0.044294, 0.039127, 0.033631, 0.036279, 0.050599, 0.070100
#*# 	  0.069395, 0.039547, 0.029058, 0.025601, 0.019709, 0.014601, 0.010850, 0.002509, -0.000565, 0.005335, 0.017364, 0.029947, 0.044521, 0.054061, 0.052320, 0.045203, 0.038305, 0.041564, 0.055084, 0.075966
#*# 	  0.084318, 0.056367, 0.044576, 0.040617, 0.034796, 0.030415, 0.024235, 0.015569, 0.009871, 0.017327, 0.028303, 0.039890, 0.055465, 0.063225, 0.059814, 0.051954, 0.047626, 0.048556, 0.063441, 0.084862
#*# 	  0.100493, 0.071832, 0.063946, 0.063068, 0.058841, 0.047398, 0.042043, 0.031386, 0.027136, 0.032733, 0.043467, 0.055519, 0.069160, 0.077205, 0.071727, 0.063863, 0.057940, 0.063314, 0.079549, 0.100257
#*# 	  0.112009, 0.085342, 0.075386, 0.079333, 0.074655, 0.061710, 0.051148, 0.041768, 0.037841, 0.044401, 0.055383, 0.069398, 0.083967, 0.091775, 0.088972, 0.079265, 0.076510, 0.080033, 0.097644, 0.118912
#*# 	  0.128502, 0.100257, 0.089260, 0.086846, 0.078096, 0.069322, 0.063791, 0.053987, 0.049227, 0.053270, 0.062008, 0.076930, 0.093474, 0.101879, 0.097710, 0.088713, 0.085605, 0.089074, 0.105669, 0.128305
#*# 	  0.141388, 0.112565, 0.102880, 0.098724, 0.091847, 0.082543, 0.074766, 0.063125, 0.057295, 0.062415, 0.073542, 0.086992, 0.102233, 0.109309, 0.106242, 0.097300, 0.093134, 0.097562, 0.111735, 0.131729
#*# 	  0.165701, 0.136851, 0.125299, 0.122072, 0.117101, 0.106513, 0.097802, 0.085515, 0.076922, 0.084056, 0.094948, 0.106956, 0.122095, 0.129477, 0.128240, 0.118102, 0.114668, 0.117657, 0.130104, 0.145731
#*# 	  0.192171, 0.164460, 0.150728, 0.146141, 0.136778, 0.126850, 0.118148, 0.106313, 0.097599, 0.102107, 0.112695, 0.123554, 0.136229, 0.144460, 0.141846, 0.132293, 0.127419, 0.129547, 0.137820, 0.151146
#*# x_count = 20
#*# y_count = 20
#*# mesh_x_pps = 2
#*# mesh_y_pps = 2
#*# algo = bicubic
#*# tension = 0.2
#*# min_x = 20.0
#*# max_x = 370.0
#*# min_y = 21.0
#*# max_y = 340.0
#*#
